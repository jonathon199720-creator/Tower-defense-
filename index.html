<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nexus Defense: ULTIMATE - Complete Edition</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

```
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  color: #e0e7ff;
  padding: 10px;
  overflow: hidden;
}

#gameContainer {
  display: flex;
  gap: 20px;
  width: 100%;
  max-width: 1600px;
  height: 95vh;
}

#gameArea {
  flex: 1;
  min-width: 600px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#canvas {
  flex: 1;
  border: 2px solid rgba(59, 130, 246, 0.5);
  border-radius: 8px;
  background: linear-gradient(135deg, #0a0e27, #1a1f3a);
  cursor: crosshair;
  image-rendering: crisp-edges;
  box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
}

.panel {
  background: rgba(15, 23, 42, 0.95);
  border: 1px solid rgba(59, 130, 246, 0.3);
  padding: 15px;
  border-radius: 8px;
  backdrop-filter: blur(10px);
  box-shadow: 0 0 10px rgba(59, 130, 246, 0.1);
}

.controls {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
  gap: 8px;
}

button {
  padding: 10px;
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  border: 1px solid #60a5fa;
  color: #e0e7ff;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  font-size: 11px;
  transition: all 0.3s;
  min-height: 44px;
  box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
}

button:hover:not(:disabled) {
  background: linear-gradient(135deg, #60a5fa, #3b82f6);
  box-shadow: 0 0 20px rgba(59, 130, 246, 0.7);
  transform: translateY(-2px);
}

button:active:not(:disabled) {
  transform: translateY(0);
}

button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

button.active {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  border-color: #fbbf24;
  box-shadow: 0 0 20px rgba(251, 191, 36, 0.7);
}

#sidebar {
  flex: 0 0 320px;
  display: flex;
  flex-direction: column;
  gap: 15px;
  max-height: 95vh;
  overflow-y: auto;
  padding-right: 5px;
}

#sidebar::-webkit-scrollbar {
  width: 6px;
}

#sidebar::-webkit-scrollbar-track {
  background: rgba(59, 130, 246, 0.1);
  border-radius: 3px;
}

#sidebar::-webkit-scrollbar-thumb {
  background: rgba(59, 130, 246, 0.4);
  border-radius: 3px;
}

.tab-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 6px;
}

.tab-buttons button {
  padding: 6px;
  font-size: 10px;
  min-height: 36px;
}

.tab-content {
  display: none;
  max-height: 400px;
  overflow-y: auto;
  flex: 1;
}

.tab-content.active {
  display: block;
}

.tower-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.tower-card {
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  padding: 8px;
  border-radius: 4px;
  font-size: 10px;
  cursor: pointer;
  transition: all 0.2s;
}

.tower-card:hover {
  background: rgba(59, 130, 246, 0.2);
  border-color: rgba(59, 130, 246, 0.6);
  transform: translateY(-2px);
}

.tower-card.selected {
  background: rgba(251, 191, 36, 0.2);
  border-color: #fbbf24;
  box-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
}

.tower-name {
  font-weight: bold;
  color: #60a5fa;
  margin-bottom: 3px;
}

.tower-stat {
  color: #cbd5e1;
  font-size: 9px;
  margin: 1px 0;
}

.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.stat-box {
  text-align: center;
  padding: 10px;
  background: rgba(59, 130, 246, 0.1);
  border-radius: 4px;
  border: 1px solid rgba(59, 130, 246, 0.3);
  transition: all 0.3s;
}

.stat-box:hover {
  background: rgba(59, 130, 246, 0.2);
  transform: scale(1.05);
}

.stat-label {
  font-size: 10px;
  color: #60a5fa;
  font-weight: bold;
}

.stat-value {
  font-size: 18px;
  color: #fbbf24;
  font-weight: bold;
  margin-top: 4px;
}

.achievement-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
}

.achievement {
  background: rgba(34, 197, 94, 0.1);
  border: 1px solid rgba(34, 197, 94, 0.3);
  padding: 8px;
  border-radius: 4px;
  font-size: 9px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.achievement:hover {
  background: rgba(34, 197, 94, 0.2);
}

.achievement.locked {
  opacity: 0.5;
  background: rgba(107, 114, 128, 0.1);
  border-color: rgba(107, 114, 128, 0.3);
}

.achievement-icon {
  font-size: 18px;
  margin-bottom: 4px;
}

.achievement-name {
  font-weight: bold;
  color: #22c55e;
  margin-bottom: 2px;
}

.message {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(16, 185, 129, 0.95);
  padding: 20px 40px;
  border-radius: 8px;
  font-weight: bold;
  z-index: 1000;
  animation: slideIn 0.3s ease;
  pointer-events: none;
  box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translate(-50%, -60%);
  }
  to {
    opacity: 1;
    transform: translate(-50%, -50%);
  }
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
  overflow-y: auto;
  padding: 20px;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: linear-gradient(135deg, #1e293b, #0f172a);
  border: 2px solid rgba(59, 130, 246, 0.5);
  border-radius: 12px;
  padding: 25px;
  max-width: 90vw;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 0 40px rgba(59, 130, 246, 0.4);
  margin: auto;
}

.modal-title {
  font-size: 22px;
  font-weight: bold;
  color: #60a5fa;
  margin-bottom: 20px;
  border-bottom: 2px solid rgba(59, 130, 246, 0.3);
  padding-bottom: 12px;
}

.level-banner {
  text-align: center;
  padding: 18px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(251, 191, 36, 0.1));
  border: 2px solid rgba(59, 130, 246, 0.4);
  border-radius: 8px;
  box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
}

.level-title {
  font-size: 20px;
  font-weight: bold;
  color: #fbbf24;
  text-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
}

.level-description {
  font-size: 12px;
  color: #60a5fa;
  margin-top: 8px;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: rgba(107, 114, 128, 0.3);
  border-radius: 4px;
  overflow: hidden;
  margin: 10px 0;
  border: 1px solid rgba(59, 130, 246, 0.2);
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6, #60a5fa, #3b82f6);
  background-size: 200% 100%;
  animation: shimmer 2s infinite;
  transition: width 0.3s ease;
}

@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.leaderboard-entry {
  display: flex;
  justify-content: space-between;
  padding: 8px;
  border-bottom: 1px solid rgba(59, 130, 246, 0.2);
  font-size: 11px;
  transition: all 0.2s;
}

.leaderboard-entry:hover {
  background: rgba(59, 130, 246, 0.1);
}

.leaderboard-rank {
  font-weight: bold;
  color: #fbbf24;
  min-width: 30px;
}

.leaderboard-name {
  flex: 1;
  color: #60a5fa;
}

.leaderboard-score {
  color: #22c55e;
  font-weight: bold;
}

.settings-item {
  margin: 12px 0;
  padding: 10px;
  background: rgba(59, 130, 246, 0.1);
  border-radius: 4px;
  border: 1px solid rgba(59, 130, 246, 0.2);
}

.settings-label {
  display: block;
  margin-bottom: 6px;
  font-weight: bold;
  color: #60a5fa;
  font-size: 11px;
}

input[type="range"], select, input[type="text"] {
  width: 100%;
  padding: 6px;
  background: rgba(30, 41, 59, 0.9);
  border: 1px solid rgba(59, 130, 246, 0.5);
  color: #e0e7ff;
  border-radius: 4px;
  font-size: 11px;
}

input[type="range"] {
  cursor: pointer;
}

input[type="checkbox"] {
  margin-right: 6px;
  cursor: pointer;
}

.upgrade-card {
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  padding: 10px;
  border-radius: 4px;
  margin: 8px 0;
  cursor: pointer;
  transition: all 0.2s;
}

.upgrade-card:hover {
  background: rgba(59, 130, 246, 0.2);
  transform: translateX(5px);
}

.screen-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(15, 23, 42, 0.95));
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 3000;
  flex-direction: column;
}

.screen-overlay.active {
  display: flex;
}

.screen-content {
  text-align: center;
  color: #e0e7ff;
}

.screen-title {
  font-size: 56px;
  font-weight: bold;
  color: #fbbf24;
  margin-bottom: 20px;
  text-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
}

.screen-subtitle {
  font-size: 28px;
  color: #60a5fa;
  margin-bottom: 40px;
}

.screen-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 20px;
  margin: 40px 0;
}

.stat-item {
  background: rgba(59, 130, 248, 0.2);
  padding: 25px;
  border-radius: 8px;
  border: 2px solid rgba(59, 130, 246, 0.4);
}

.stat-item-label {
  color: #60a5fa;
  font-size: 14px;
  margin-bottom: 8px;
}

.stat-item-value {
  font-size: 32px;
  font-weight: bold;
  color: #fbbf24;
}

.level-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
  gap: 8px;
  max-height: 300px;
  overflow-y: auto;
}

.level-btn {
  padding: 10px;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  color: #60a5fa;
  border-radius: 4px;
  cursor: pointer;
  font-size: 10px;
  font-weight: bold;
  transition: all 0.2s;
}

.level-btn:hover {
  background: rgba(59, 130, 246, 0.2);
  transform: scale(1.05);
}

.level-btn.completed {
  background: rgba(34, 197, 94, 0.2);
  border-color: rgba(34, 197, 94, 0.6);
  color: #22c55e;
}

.level-btn.active {
  background: rgba(251, 191, 36, 0.2);
  border-color: #fbbf24;
  color: #fbbf24;
}

.tutorial-box {
  background: rgba(59, 130, 246, 0.15);
  border: 2px solid rgba(59, 130, 246, 0.4);
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
  font-size: 11px;
  line-height: 1.6;
}

.tutorial-title {
  font-weight: bold;
  color: #fbbf24;
  margin-bottom: 8px;
}

.daily-modifier {
  background: rgba(249, 115, 22, 0.1);
  border: 1px solid rgba(249, 115, 22, 0.4);
  padding: 10px;
  border-radius: 4px;
  margin: 8px 0;
  font-size: 11px;
}

.modifier-name {
  font-weight: bold;
  color: #f59e0b;
}

.modifier-effect {
  color: #cbd5e1;
  font-size: 10px;
  margin-top: 4px;
}

@media (max-width: 1024px) {
  #gameContainer {
    flex-direction: column;
  }

  #gameArea {
    min-width: auto;
  }

  #sidebar {
    flex: 0 0 auto;
    max-height: 40vh;
  }

  #canvas {
    min-height: 300px;
  }
}

@media (max-width: 768px) {
  body {
    padding: 5px;
  }

  #gameContainer {
    height: auto;
    gap: 10px;
  }

  #gameArea {
    gap: 5px;
  }

  #sidebar {
    max-height: 35vh;
  }

  #canvas {
    min-height: 250px;
  }

  button {
    font-size: 9px;
    min-height: 38px;
    padding: 6px;
  }

  .modal-content {
    padding: 15px;
  }

  .modal-title {
    font-size: 16px;
  }

  .screen-title {
    font-size: 32px;
  }

  .screen-subtitle {
    font-size: 18px;
  }

  .screen-stats {
    gap: 15px;
  }

  .stat-item {
    padding: 15px;
  }

  .stat-item-value {
    font-size: 24px;
  }
}

.spinner {
  border: 4px solid rgba(59, 130, 246, 0.2);
  border-top: 4px solid #60a5fa;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.reward-text {
  color: #22c55e;
  font-weight: bold;
  font-size: 12px;
}

.cost-badge {
  display: inline-block;
  background: rgba(239, 68, 68, 0.3);
  color: #ef4444;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 9px;
  margin-left: 4px;
  font-weight: bold;
}
```

  </style>
</head>
<body>
  <div id="gameContainer">
    <div id="gameArea">
      <div class="level-banner" id="levelBanner">
        <div class="level-title">Campaign - Level 1: Training</div>
        <div class="level-description">Defend your base from incoming enemies!</div>
        <div class="progress-bar"><div class="progress-fill" id="waveProgress" style="width: 0%;"></div></div>
      </div>
      <canvas id="canvas"></canvas>
      <div class="panel">
        <div class="controls">
          <button id="startBtn" onclick="game.startWave()">‚ñ∂ WAVE</button>
          <button id="pauseBtn" onclick="game.togglePause()">‚è∏</button>
          <button id="speedBtn" onclick="game.toggleSpeed()">2x</button>
          <button onclick="game.showModal('upgrades')">üîß</button>
          <button onclick="game.showModal('settings')">‚öôÔ∏è</button>
          <button onclick="game.showModal('menu')">üìã</button>
          <button onclick="game.showTutorial()">‚ùì</button>
        </div>
      </div>
    </div>

```
<div id="sidebar" class="panel">
  <div class="tab-buttons">
    <button class="tab-btn active" onclick="game.switchTab('towers')">üèóÔ∏è</button>
    <button class="tab-btn" onclick="game.switchTab('stats')">üìä</button>
    <button class="tab-btn" onclick="game.switchTab('help')">‚ÑπÔ∏è</button>
  </div>

  <div class="tab-content active" id="towers-tab">
    <div class="tower-grid" id="towerGrid"></div>
  </div>

  <div class="tab-content" id="stats-tab">
    <div class="stats-grid" id="statsGrid"></div>
    <div style="margin-top: 12px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 4px; border: 1px solid rgba(59, 130, 246, 0.2); font-size: 10px;">
      <div style="margin: 4px 0;"><strong style="color: #60a5fa;">Session Stats:</strong></div>
      <div>‚öîÔ∏è Kills: <span id="killStat" style="color: #fbbf24; font-weight: bold;">0</span></div>
      <div>üèóÔ∏è Built: <span id="builtStat" style="color: #fbbf24; font-weight: bold;">0</span></div>
      <div>üåä Waves: <span id="waveStat" style="color: #fbbf24; font-weight: bold;">0</span></div>
      <div>‚è±Ô∏è Time: <span id="timeStat" style="color: #fbbf24; font-weight: bold;">0:00</span></div>
    </div>
  </div>

  <div class="tab-content" id="help-tab">
    <div style="font-size: 10px; line-height: 1.7; color: #cbd5e1;">
      <div style="margin-bottom: 12px;">
        <strong style="color: #60a5fa;">üéÆ HOW TO PLAY:</strong>
      </div>
      <div style="margin-bottom: 8px;">1. Select a tower from the left</div>
      <div style="margin-bottom: 8px;">2. Click on canvas to build</div>
      <div style="margin-bottom: 8px;">3. Press ‚ñ∂ WAVE to start</div>
      <div style="margin-bottom: 8px;">4. Defend for 20 waves</div>
      <div style="margin-bottom: 12px;">5. Defeat all enemies to win</div>

      <div style="margin-bottom: 12px; border-top: 1px solid rgba(59, 130, 246, 0.2); padding-top: 8px;">
        <strong style="color: #60a5fa;">üí° TIPS:</strong>
      </div>
      <div style="margin-bottom: 8px;">‚Ä¢ Mix tower types</div>
      <div style="margin-bottom: 8px;">‚Ä¢ Upgrade strategically</div>
      <div style="margin-bottom: 8px;">‚Ä¢ Plan ahead</div>
      <div style="margin-bottom: 8px;">‚Ä¢ Use range effectively</div>
    </div>
  </div>
</div>
```

  </div>

  <!-- MAIN MENU MODAL -->

  <div id="menu" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-title">‚öîÔ∏è NEXUS DEFENSE: ULTIMATE ‚öîÔ∏è</div>
      <div style="text-align: center; margin-bottom: 20px; font-size: 13px; color: #60a5fa;">
        Complete Edition - All Features Unlocked
      </div>
      <div style="margin: 15px 0;">
        <button onclick="game.startCampaign()" style="width: 100%; margin: 10px 0; padding: 12px; font-size: 13px;">üìñ CAMPAIGN (30 LEVELS)</button>
        <button onclick="game.startEndless()" style="width: 100%; margin: 10px 0; padding: 12px; font-size: 13px;">‚àû ENDLESS MODE</button>
        <button onclick="game.startDaily()" style="width: 100%; margin: 10px 0; padding: 12px; font-size: 13px;">üéØ DAILY CHALLENGE</button>
        <button onclick="game.showModal('achievements')" style="width: 100%; margin: 10px 0; padding: 12px; font-size: 13px;">üèÜ ACHIEVEMENTS</button>
        <button onclick="game.showModal('leaderboard')" style="width: 100%; margin: 10px 0; padding: 12px; font-size: 13px;">üìà LEADERBOARD</button>
        <button onclick="game.showModal('levelSelect')" style="width: 100%; margin: 10px 0; padding: 12px; font-size: 13px;">üìö SELECT LEVEL</button>
        <button onclick="game.showModal('editor')" style="width: 100%; margin: 10px 0; padding: 12px; font-size: 13px;">üé® LEVEL EDITOR</button>
        <button onclick="game.closeModal('menu')" style="width: 100%; margin: 10px 0; padding: 12px; font-size: 13px; background: linear-gradient(135deg, #6b7280, #4b5563);">RESUME GAME</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->

  <div id="settings" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-title">‚öôÔ∏è SETTINGS</div>

```
  <div class="settings-item">
    <label class="settings-label">Game Difficulty</label>
    <select id="difficultySelect" onchange="game.changeDifficulty()">
      <option value="easy">Easy (70% Health)</option>
      <option value="normal" selected>Normal (100% Health)</option>
      <option value="hard">Hard (130% Health)</option>
      <option value="extreme">Extreme (160% Health)</option>
    </select>
  </div>

  <div class="settings-item">
    <label class="settings-label">Master Volume: <span id="volValue">80</span>%</label>
    <input type="range" id="volSlider" min="0" max="100" value="80" onchange="game.updateVolume()">
  </div>

  <div class="settings-item">
    <label style="font-size: 11px; cursor: pointer;">
      <input type="checkbox" id="soundCheck" checked onchange="game.updateSettings()"> Sound Effects
    </label>
  </div>

  <div class="settings-item">
    <label style="font-size: 11px; cursor: pointer;">
      <input type="checkbox" id="particlesCheck" checked onchange="game.updateSettings()"> Particle Effects
    </label>
  </div>

  <div class="settings-item">
    <label style="font-size: 11px; cursor: pointer;">
      <input type="checkbox" id="musicCheck" checked onchange="game.updateSettings()"> Background Music
    </label>
  </div>

  <div class="settings-item">
    <label style="font-size: 11px; cursor: pointer;">
      <input type="checkbox" id="helpCheck" checked onchange="game.updateSettings()"> Show Help Tooltips
    </label>
  </div>

  <button onclick="game.closeModal('settings')" style="width: 100%; margin-top: 15px;">CLOSE</button>
</div>
```

  </div>

  <!-- UPGRADES MODAL -->

  <div id="upgrades" class="modal">
    <div class="modal-content">
      <div class="modal-title">üîß TOWER UPGRADES</div>
      <div style="font-size: 11px; margin-bottom: 15px; color: #60a5fa;">Upgrade all towers of a type to boost their stats permanently for this game.</div>
      <div id="upgradesContent" style="max-height: 400px; overflow-y: auto;"></div>
      <button onclick="game.closeModal('upgrades')" style="width: 100%; margin-top: 15px;">CLOSE</button>
    </div>
  </div>

  <!-- ACHIEVEMENTS MODAL -->

  <div id="achievements" class="modal">
    <div class="modal-content">
      <div class="modal-title">üèÜ ACHIEVEMENTS</div>
      <div style="font-size: 11px; margin-bottom: 12px; color: #60a5fa;">Unlock achievements by completing challenges. Hover for details.</div>
      <div class="achievement-grid" id="achievementGrid"></div>
      <div style="margin-top: 15px; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 4px; font-size: 10px;">
        <strong style="color: #22c55e;">Progress: <span id="achievementCount">0</span>/8 Unlocked</strong>
      </div>
      <button onclick="game.closeModal('achievements')" style="width: 100%; margin-top: 15px;">CLOSE</button>
    </div>
  </div>

  <!-- LEADERBOARD MODAL -->

  <div id="leaderboard" class="modal">
    <div class="modal-content">
      <div class="modal-title">üìà LEADERBOARD</div>
      <div id="leaderboardContent" style="max-height: 400px; overflow-y: auto;"></div>
      <button onclick="game.closeModal('leaderboard')" style="width: 100%; margin-top: 15px;">CLOSE</button>
    </div>
  </div>

  <!-- LEVEL SELECT MODAL -->

  <div id="levelSelect" class="modal">
    <div class="modal-content">
      <div class="modal-title">üìö SELECT CAMPAIGN LEVEL</div>
      <div class="level-grid" id="levelGrid"></div>
      <button onclick="game.closeModal('levelSelect')" style="width: 100%; margin-top: 15px;">CLOSE</button>
    </div>
  </div>

  <!-- LEVEL EDITOR MODAL -->

  <div id="editor" class="modal">
    <div class="modal-content">
      <div class="modal-title">üé® LEVEL EDITOR</div>
      <div style="font-size: 11px; margin-bottom: 12px; color: #60a5fa;">Create and test custom levels.</div>
      <div class="settings-item">
        <label class="settings-label">Level Name</label>
        <input type="text" id="editorName" placeholder="My Custom Level">
      </div>
      <div class="settings-item">
        <label class="settings-label">Starting Money: <span id="editorMoneyValue">800</span></label>
        <input type="range" id="editorMoney" min="500" max="2000" value="800" onchange="document.getElementById('editorMoneyValue').textContent = this.value">
      </div>
      <div class="settings-item">
        <label class="settings-label">Total Waves: <span id="editorWavesValue">10</span></label>
        <input type="range" id="editorWaves" min="5" max="30" value="10" onchange="document.getElementById('editorWavesValue').textContent = this.value">
      </div>
      <div class="settings-item">
        <label class="settings-label">Difficulty Multiplier: <span id="editorDiffValue">1.0</span></label>
        <input type="range" id="editorDiff" min="0.5" max="3" step="0.1" value="1.0" onchange="document.getElementById('editorDiffValue').textContent = this.value">
      </div>
      <button onclick="game.testCustomLevel()" style="width: 100%; margin: 10px 0;">üéÆ TEST LEVEL</button>
      <button onclick="game.saveCustomLevel()" style="width: 100%; margin: 10px 0;">üíæ SAVE LEVEL</button>
      <button onclick="game.closeModal('editor')" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #6b7280, #4b5563);">CLOSE</button>
    </div>
  </div>

  <!-- DAILY CHALLENGE MODAL -->

  <div id="dailyChallenge" class="modal">
    <div class="modal-content">
      <div class="modal-title">üéØ DAILY CHALLENGE</div>
      <div style="margin: 15px 0;">
        <div style="font-size: 12px; color: #60a5fa; margin-bottom: 10px;">Today's Challenge (Resets daily)</div>
        <div id="dailyModifiers"></div>
        <button onclick="game.startDaily()" style="width: 100%; margin: 15px 0; padding: 12px;">‚ñ∂ START CHALLENGE</button>
      </div>
      <button onclick="game.closeModal('dailyChallenge')" style="width: 100%; background: linear-gradient(135deg, #6b7280, #4b5563);">CLOSE</button>
    </div>
  </div>

  <!-- TUTORIAL MODAL -->

  <div id="tutorial" class="modal">
    <div class="modal-content">
      <div class="modal-title">‚ùì TUTORIAL</div>

```
  <div class="tutorial-box">
    <div class="tutorial-title">üéÆ Getting Started</div>
    Select a tower type from the left panel, then click on the game canvas to place it. Each tower costs money and deals damage to enemies automatically.
  </div>

  <div class="tutorial-box">
    <div class="tutorial-title">üåä Waves</div>
    Press "‚ñ∂ WAVE" to start each wave. Enemies will spawn and move across the screen. Defend your base - if 3+ enemies escape, you lose!
  </div>

  <div class="tutorial-box">
    <div class="tutorial-title">üí∞ Economy</div>
    Earn money by defeating enemies. Use it to build more towers. Right-click towers to sell them for 80% refund. Plan your purchases wisely!
  </div>

  <div class="tutorial-box">
    <div class="tutorial-title">üîß Upgrades</div>
    Use the UPGRADE button to boost specific tower types. All towers of that type gain bonus damage and range for the rest of the game.
  </div>

  <div class="tutorial-box">
    <div class="tutorial-title">‚öôÔ∏è Game Modes</div>
    <strong>Campaign:</strong> 30 progressive levels with increasing difficulty.<br>
    <strong>Endless:</strong> Survive infinite waves with growing challenge.<br>
    <strong>Daily:</strong> Complete today's special challenge for bonus achievements.
  </div>

  <div class="tutorial-box">
    <div class="tutorial-title">üìä Stats & Goals</div>
    Track your progress in the STATS tab. Unlock achievements by completing specific challenges. See your scores on the leaderboard!
  </div>

  <button onclick="game.closeModal('tutorial')" style="width: 100%; margin-top: 15px;">CLOSE</button>
</div>
```

  </div>

  <!-- GAME OVER / WIN SCREEN -->

  <div id="gameOverScreen" class="screen-overlay">
    <div class="screen-content">
      <div class="screen-title" id="gameOverTitle">GAME OVER</div>
      <div class="screen-subtitle" id="gameOverSubtitle">You were defeated!</div>
      <div class="screen-stats" id="gameOverStats"></div>
      <button onclick="game.returnToMenu()" style="margin-top: 30px; padding: 15px 40px; font-size: 16px;">RETURN TO MENU</button>
      <button onclick="game.retryLevel()" style="margin-top: 10px; padding: 15px 40px; font-size: 16px;">RETRY LEVEL</button>
    </div>
  </div>

  <script>
    // ===== GAME CONSTANTS - TOWERS =====
    const TOWER_TYPES = [
      { 
        id: 0, name: "Laser", cost: 200, damage: 12, range: 120, fireRate: 40, 
        color: "#00bfff", emoji: "‚ö°", desc: "Fast shooter",
        upgradeCost: 100, ability: "Chains to nearby enemies"
      },
      { 
        id: 1, name: "Cannon", cost: 280, damage: 20, range: 150, fireRate: 60, 
        color: "#ff8c00", emoji: "üí£", desc: "Heavy hitter",
        upgradeCost: 150, ability: "Splits on hit"
      },
      { 
        id: 2, name: "Pulse", cost: 240, damage: 8, range: 160, fireRate: 25, 
        color: "#00ff88", emoji: "„Ä∞", desc: "AOE damage",
        upgradeCost: 120, ability: "Heals nearby towers"
      },
      { 
        id: 3, name: "Sniper", cost: 300, damage: 35, range: 200, fireRate: 80, 
        color: "#ff0080", emoji: "üéØ", desc: "One-shot master",
        upgradeCost: 180, ability: "Pierces targets"
      },
      { 
        id: 4, name: "Healer", cost: 250, damage: 0, range: 140, fireRate: 30, 
        color: "#22c55e", emoji: "üíö", desc: "Repairs towers",
        upgradeCost: 140, ability: "Repairs fast"
      },
      { 
        id: 5, name: "Blaster", cost: 320, damage: 15, range: 180, fireRate: 50, 
        color: "#ffff00", emoji: "üí•", desc: "Burst attacker",
        upgradeCost: 160, ability: "Explosive waves"
      }
    ];

    // ===== GAME CONSTANTS - ENEMIES =====
    const ENEMY_TYPES = [
      { id: 0, name: "Scout", speedMult: 1.1, hpMult: 0.8, color: "#ffeb3b", emoji: "üëæ", reward: 10, description: "Fast but weak" },
      { id: 1, name: "Trooper", speedMult: 1.0, hpMult: 1.0, color: "#ef4444", emoji: "ü§ñ", reward: 15, description: "Balanced" },
      { id: 2, name: "Tank", speedMult: 0.6, hpMult: 1.5, color: "#a855f7", emoji: "‚öî", reward: 25, description: "Slow and tanky" },
      { id: 3, name: "Boss", speedMult: 0.8, hpMult: 3.0, color: "#dc2626", emoji: "üëë", reward: 100, description: "Tough boss" },
      { id: 4, name: "Flying", speedMult: 1.3, hpMult: 0.9, color: "#06b6d4", emoji: "ü¶Ö", reward: 20, description: "Very fast" },
      { id: 5, name: "Heavy", speedMult: 0.7, hpMult: 2.0, color: "#8b7355", emoji: "üõ°Ô∏è", reward: 30, description: "Armored" }
    ];

    // ===== GAME CONSTANTS - ACHIEVEMENTS =====
    const ACHIEVEMENTS = [
      { id: "firstKill", name: "First Blood", desc: "Kill your first enemy", icon: "‚öîÔ∏è", unlocked: false },
      { id: "perfect", name: "Flawless", desc: "Complete wave with 0 escapes", icon: "üõ°Ô∏è", unlocked: false },
      { id: "wealthy", name: "Rich", desc: "Accumulate $1000+", icon: "üí∞", unlocked: false },
      { id: "builder", name: "Builder", desc: "Build 20 towers", icon: "üèóÔ∏è", unlocked: false },
      { id: "slayer", name: "Slayer", desc: "Kill 1000 enemies total", icon: "‚öîÔ∏è", unlocked: false },
      { id: "speedrun", name: "Speed Runner", desc: "Complete level in <90 seconds", icon: "‚ö°", unlocked: false },
      { id: "endless10", name: "Endless Warrior", desc: "Reach wave 10+ in endless", icon: "‚àû", unlocked: false },
      { id: "master", name: "Master", desc: "Use all tower types", icon: "üéØ", unlocked: false }
    ];

    // ===== CAMPAIGN LEVELS =====
    const CAMPAIGN_LEVELS = [
      { name: "Training", waves: 5, startMoney: 800, baseEnemies: 5, desc: "Learn the basics" },
      { name: "Valley", waves: 7, startMoney: 750, baseEnemies: 6, desc: "First real challenge" },
      { name: "Mountain", waves: 8, startMoney: 700, baseEnemies: 7, desc: "Higher altitude" },
      { name: "Forest", waves: 9, startMoney: 650, baseEnemies: 8, desc: "Dense forest" },
      { name: "Desert", waves: 10, startMoney: 600, baseEnemies: 9, desc: "Hot and dry" },
      { name: "Fortress", waves: 12, startMoney: 550, baseEnemies: 10, desc: "Heavy defense" },
      { name: "Volcano", waves: 13, startMoney: 500, baseEnemies: 11, desc: "Molten core" },
      { name: "Arctic", waves: 14, startMoney: 450, baseEnemies: 12, desc: "Frozen wastes" },
      { name: "Ruins", waves: 15, startMoney: 400, baseEnemies: 13, desc: "Ancient city" },
      { name: "Final", waves: 20, startMoney: 350, baseEnemies: 15, desc: "Ultimate test" }
    ];

    // Add more campaign levels (20-30 total)
    for (let i = 10; i < 30; i++) {
      const diff = Math.floor(i / 5);
      CAMPAIGN_LEVELS.push({
        name: `Zone ${String.fromCharCode(65 + (i % 26))}`,
        waves: 10 + (i * 2),
        startMoney: 800 - (i * 20),
        baseEnemies: 8 + i,
        desc: `Difficulty level ${diff + 1}`
      });
    }

    // ===== MAIN GAME OBJECT =====
    const game = {
      canvas: document.getElementById('canvas'),
      ctx: null,
      audioContext: null,

      state: {
        mode: null,
        campaignLevel: 0,
        wave: 0,
        waveTarget: 0,
        money: 800,
        lives: 20,
        score: 0,
        kills: 0,
        towersBuilt: 0,
        waveActive: false,
        isPaused: false,
        speedX2: false,
        difficulty: 'normal',
        towers: [],
        enemies: [],
        particles: [],
        selectedTower: -1,
        levelStartTime: 0,
        sessionStartTime: 0,
        stats: {
          totalKills: 0,
          totalBuilt: 0,
          totalWaves: 0,
          totalEarned: 0,
          totalTime: 0
        },
        achievements: {},
        customLevels: [],
        dailyModifiers: []
      },

      // ===== INITIALIZATION =====
      init() {
        this.ctx = this.canvas.getContext('2d');
        this.resizeCanvas();
        window.addEventListener('resize', () => this.resizeCanvas());
        this.canvas.addEventListener('click', (e) => this.handleClick(e));
        this.canvas.addEventListener('contextmenu', (e) => { e.preventDefault(); this.handleRightClick(e); });
        
        try {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          console.log('Audio not supported');
        }

        ACHIEVEMENTS.forEach(a => {
          this.state.achievements[a.id] = localStorage.getItem(`ach_${a.id}`) === 'true';
        });

        this.loadCustomLevels();
        this.loadLeaderboard();
        this.generateDailyModifiers();
        this.state.sessionStartTime = Date.now();
        this.updateUI();
        this.renderLoop();
        setTimeout(() => this.showModal('menu'), 100);
      },

      resizeCanvas() {
        this.canvas.width = this.canvas.offsetWidth;
        this.canvas.height = this.canvas.offsetHeight;
      },

      // ===== GAME MODES =====
      startCampaign() {
        this.state.mode = 'campaign';
        this.state.campaignLevel = 0;
        this.loadCampaignLevel();
        this.closeModal('menu');
      },

      startEndless() {
        this.state.mode = 'endless';
        this.state.wave = 0;
        this.state.money = 800;
        this.state.lives = 20;
        this.state.score = 0;
        this.state.kills = 0;
        this.state.towers = [];
        this.state.enemies = [];
        this.state.particles = [];
        this.state.waveActive = false;
        this.state.levelStartTime = Date.now();
        this.updateUI();
        this.closeModal('menu');
      },

      startDaily() {
        this.state.mode = 'daily';
        const today = new Date().toDateString();
        const lastDaily = localStorage.getItem('lastDaily');
        
        if (lastDaily === today) {
          this.showMessage('Daily challenge already completed! Come back tomorrow!', '#f59e0b');
          return;
        }

        this.state.difficulty = 'hard';
        this.startEndless();
        
        // Apply daily modifiers
        this.state.dailyModifiers.forEach(mod => {
          if (mod.type === 'moneyMult') this.state.money = Math.floor(this.state.money * mod.value);
          if (mod.type === 'healthMult') this.state.lives = Math.floor(this.state.lives * mod.value);
          if (mod.type === 'costMult') {
            TOWER_TYPES.forEach(t => t.cost = Math.floor(t.cost * mod.value));
          }
        });

        localStorage.setItem('lastDaily', today);
        this.showMessage('Daily Challenge started with modifiers!', '#fbbf24');
      },

      loadCampaignLevel() {
        if (this.state.campaignLevel >= CAMPAIGN_LEVELS.length) {
          this.state.campaignLevel = CAMPAIGN_LEVELS.length - 1;
        }

        const level = CAMPAIGN_LEVELS[this.state.campaignLevel];
        this.state.wave = 0;
        this.state.waveTarget = level.waves;
        this.state.money = level.startMoney;
        this.state.lives = 20;
        this.state.score = 0;
        this.state.kills = 0;
        this.state.towers = [];
        this.state.enemies = [];
        this.state.particles = [];
        this.state.waveActive = false;
        this.state.levelStartTime = Date.now();
        this.updateUI();
      },

      // ===== GAMEPLAY =====
      startWave() {
        if (this.state.waveActive || this.state.lives <= 0) return;
        
        this.state.waveActive = true;
        this.state.wave++;
        this.state.stats.totalWaves++;

        if (this.state.mode === 'campaign') {
          const level = CAMPAIGN_LEVELS[this.state.campaignLevel];
          if (this.state.wave > level.waves) {
            this.levelComplete();
            return;
          }
        }

        const baseEnemyCount = this.state.mode === 'endless' 
          ? 5 + (this.state.wave * 2)
          : CAMPAIGN_LEVELS[this.state.campaignLevel].baseEnemies + (this.state.wave - 1);

        const diffMult = this.state.difficulty === 'easy' ? 0.7 : this.state.difficulty === 'hard' ? 1.3 : this.state.difficulty === 'extreme' ? 1.6 : 1.0;
        const enemyCount = Math.floor(baseEnemyCount * diffMult);

        let spawned = 0;
        const interval = setInterval(() => {
          if (!this.state.isPaused && spawned < enemyCount) {
            const type = Math.floor(Math.random() * 6);
            this.spawnEnemy(type);
            spawned++;
            this.playSound(200, 0.1, 0.05);
          }
          if (spawned >= enemyCount) clearInterval(interval);
        }, this.state.speedX2 ? 300 : 600);
      },

      spawnEnemy(type) {
        const eType = ENEMY_TYPES[type];
        const diffMult = this.state.difficulty === 'easy' ? 0.7 : this.state.difficulty === 'hard' ? 1.3 : this.state.difficulty === 'extreme' ? 1.6 : 1.0;
        const baseHp = (30 + (this.state.wave * 15)) * diffMult;
        const hp = baseHp * eType.hpMult;

        this.state.enemies.push({
          x: this.canvas.width / 2 + (Math.random() - 0.5) * 100,
          y: -30,
          hp: hp,
          maxHp: hp,
          speed: (1.5 + this.state.wave * 0.1) * eType.speedMult,
          type: type,
          vx: (Math.random() - 0.5) * 2,
          vy: 1 + Math.random() * 0.5
        });
      },

      handleClick(e) {
        if (this.state.selectedTower === -1 || this.state.isPaused || !this.state.mode) return;

        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const cost = TOWER_TYPES[this.state.selectedTower].cost;
        if (this.state.money < cost) {
          this.showMessage('Not enough money!', '#ef4444');
          this.playSound(100, 0.2, 0.1);
          return;
        }

        this.state.money -= cost;
        this.state.towersBuilt++;
        this.state.stats.totalBuilt++;

        this.state.towers.push({
          x, y,
          type: this.state.selectedTower,
          health: 100,
          maxHealth: 100,
          cooldown: 0,
          kills: 0,
          level: 0,
          upgraded: false
        });

        this.showMessage('‚úÖ Tower built!', '#10b981');
        this.playSound(440, 0.15, 0.1);
        this.updateUI();
      },

      handleRightClick(e) {
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        for (let i = this.state.towers.length - 1; i >= 0; i--) {
          const t = this.state.towers[i];
          if (Math.hypot(t.x - x, t.y - y) < 20) {
            const refund = Math.floor(TOWER_TYPES[t.type].cost * 0.8);
            this.state.money += refund;
            this.state.towers.splice(i, 1);
            this.showMessage(`Sold for $${refund}`, '#60a5fa');
            this.playSound(200, 0.15, 0.1);
            this.updateUI();
            break;
          }
        }
      },

      togglePause() {
        this.state.isPaused = !this.state.isPaused;
        document.getElementById('pauseBtn').textContent = this.state.isPaused ? '‚ñ∂' : '‚è∏';
      },

      toggleSpeed() {
        this.state.speedX2 = !this.state.speedX2;
        document.getElementById('speedBtn').textContent = this.state.speedX2 ? '1x' : '2x';
      },

      levelComplete() {
        this.state.waveActive = false;
        const elapsed = (Date.now() - this.state.levelStartTime) / 1000;

        if (elapsed < 90 && this.state.mode === 'campaign') {
          this.unlockAchievement('speedrun');
        }

        const earned = Math.floor((500 + (this.state.money * 2)) * (this.state.difficulty === 'hard' ? 1.5 : this.state.difficulty === 'extreme' ? 2 : 1));
        this.state.score += earned;
        this.state.stats.totalEarned += earned;
        this.state.stats.totalTime += elapsed;

        this.showGameOver(true);

        if (this.state.mode === 'campaign') {
          localStorage.setItem(`level_${this.state.campaignLevel}_complete`, 'true');
          if (this.state.campaignLevel < CAMPAIGN_LEVELS.length - 1) {
            this.state.campaignLevel++;
          }
        }
      },

      // ===== UI FUNCTIONS =====
      showModal(id) {
        try {
          const modal = document.getElementById(id);
          if (modal) {
            modal.classList.add('active');
            if (id === 'achievements') this.updateAchievements();
            if (id === 'leaderboard') this.updateLeaderboard();
            if (id === 'levelSelect') this.updateLevelSelect();
            if (id === 'upgrades') this.updateUpgradeMenu();
            if (id === 'dailyChallenge') this.updateDailyModal();
          }
        } catch (e) {
          console.error('Modal error:', e);
        }
      },

      closeModal(id) {
        try {
          const modal = document.getElementById(id);
          if (modal) modal.classList.remove('active');
        } catch (e) {
          console.error('Close modal error:', e);
        }
      },

      switchTab(tab) {
        try {
          document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
          document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
          const tabEl = document.getElementById(tab + '-tab');
          if (tabEl) tabEl.classList.add('active');
          if (event && event.target) event.target.classList.add('active');
        } catch (e) {
          console.error('Tab switch error:', e);
        }
      },

      updateUI() {
        try {
          const bannEl = document.getElementById('levelBanner');
          if (bannEl) {
            let html = '';
            if (this.state.mode === 'campaign') {
              const level = CAMPAIGN_LEVELS[this.state.campaignLevel];
              html = `<div class="level-title">${level.name} - Level ${this.state.campaignLevel + 1}</div><div class="level-description">${level.desc}</div><div class="level-description">Wave ${this.state.wave}/${this.state.waveTarget}</div>`;
            } else if (this.state.mode === 'endless') {
              html = `<div class="level-title">ENDLESS MODE</div><div class="level-description">Wave ${this.state.wave} | Score: ${this.state.score}</div>`;
            } else if (this.state.mode === 'daily') {
              html = `<div class="level-title">DAILY CHALLENGE</div><div class="level-description">Wave ${this.state.wave} | Difficulty: ${this.state.difficulty.toUpperCase()}</div>`;
            }
            bannEl.innerHTML = html;

            const prog = document.getElementById('waveProgress');
            if (prog && this.state.waveTarget > 0) {
              prog.style.width = ((this.state.wave / this.state.waveTarget) * 100) + '%';
            }
          }

          const towerGrid = document.getElementById('towerGrid');
          if (towerGrid) {
            towerGrid.innerHTML = '';
            TOWER_TYPES.forEach(t => {
              const card = document.createElement('div');
              card.className = 'tower-card' + (this.state.selectedTower === t.id ? ' selected' : '');
              const disabled = this.state.money < t.cost ? ' disabled' : '';
              card.innerHTML = `
                <div class="tower-name">${t.emoji} ${t.name}</div>
                <div class="tower-stat">${t.desc}</div>
                <div class="tower-stat" style="color: ${this.state.money >= t.cost ? '#22c55e' : '#ef4444'};">Cost: $${t.cost}</div>
              `;
              card.onclick = () => {
                this.state.selectedTower = this.state.selectedTower === t.id ? -1 : t.id;
                this.updateUI();
              };
              towerGrid.appendChild(card);
            });
          }

          const statsGrid = document.getElementById('statsGrid');
          if (statsGrid) {
            statsGrid.innerHTML = `
              <div class="stat-box"><div class="stat-label">üí∞</div><div class="stat-value">$${this.state.money}</div></div>
              <div class="stat-box"><div class="stat-label">‚ù§Ô∏è</div><div class="stat-value">${this.state.lives}</div></div>
              <div class="stat-box"><div class="stat-label">üìä</div><div class="stat-value">${this.state.score}</div></div>
              <div class="stat-box"><div class="stat-label">üèóÔ∏è</div><div class="stat-value">${this.state.towers.length}</div></div>
            `;
          }

          if (document.getElementById('killStat')) document.getElementById('killStat').textContent = this.state.kills;
          if (document.getElementById('builtStat')) document.getElementById('builtStat').textContent = this.state.towersBuilt;
          if (document.getElementById('waveStat')) document.getElementById('waveStat').textContent = this.state.wave;
          if (document.getElementById('timeStat')) {
            const elapsed = Math.floor((Date.now() - this.state.levelStartTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('timeStat').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
          }
        } catch (e) {
          console.error('UI update error:', e);
        }
      },

      updateAchievements() {
        try {
          const grid = document.getElementById('achievementGrid');
          if (!grid) return;
          grid.innerHTML = '';

          let unlockedCount = 0;
          ACHIEVEMENTS.forEach(a => {
            if (this.state.achievements[a.id]) unlockedCount++;

            const div = document.createElement('div');
            div.className = 'achievement' + (this.state.achievements[a.id] ? '' : ' locked');
            div.title = a.desc;
            div.innerHTML = `
              <div class="achievement-icon">${a.icon}</div>
              <div class="achievement-name">${a.name}</div>
              <div style="font-size: 8px; color: #a0aec0;">${a.desc}</div>
            `;
            grid.appendChild(div);
          });

          const count = document.getElementById('achievementCount');
          if (count) count.textContent = unlockedCount;
        } catch (e) {
          console.error('Achievement update error:', e);
        }
      },

      updateLeaderboard() {
        try {
          const content = document.getElementById('leaderboardContent');
          if (!content) return;
          const scores = JSON.parse(localStorage.getItem('nexusScores') || '[]').sort((a, b) => b.score - a.score).slice(0, 10);

          let html = '';
          if (scores.length === 0) {
            html = '<div style="text-align: center; color: #60a5fa; padding: 20px; font-size: 12px;">No scores yet. Start playing to appear on the leaderboard!</div>';
          } else {
            scores.forEach((s, i) => {
              html += `<div class="leaderboard-entry">
                <span class="leaderboard-rank">#${i + 1}</span>
                <span class="leaderboard-name">${s.name}</span>
                <span class="leaderboard-score">${s.score}</span>
              </div>`;
            });
          }
          content.innerHTML = html;
        } catch (e) {
          console.error('Leaderboard error:', e);
        }
      },

      updateLevelSelect() {
        try {
          const grid = document.getElementById('levelGrid');
          if (!grid) return;
          grid.innerHTML = '';

          CAMPAIGN_LEVELS.forEach((level, i) => {
            const btn = document.createElement('button');
            btn.className = 'level-btn';
            
            const completed = localStorage.getItem(`level_${i}_complete`) === 'true';
            if (completed) btn.classList.add('completed');
            if (i === this.state.campaignLevel) btn.classList.add('active');

            btn.textContent = `Lvl ${i + 1}`;
            btn.onclick = () => {
              this.state.campaignLevel = i;
              this.loadCampaignLevel();
              this.closeModal('levelSelect');
              this.showMessage(`Loaded Level ${i + 1}: ${level.name}`, '#60a5fa');
            };
            grid.appendChild(btn);
          });
        } catch (e) {
          console.error('Level select error:', e);
        }
      },

      updateUpgradeMenu() {
        try {
          const content = document.getElementById('upgradesContent');
          if (!content) return;

          let html = '<div style="max-height: 400px; overflow-y: auto;">';
          TOWER_TYPES.forEach(t => {
            const cost = t.upgradeCost;
            html += `
              <div class="upgrade-card">
                <div style="font-weight: bold; color: #60a5fa; margin-bottom: 4px;">${t.emoji} ${t.name}</div>
                <div style="font-size: 10px; color: #cbd5e1; margin-bottom: 6px;">
                  Upgrade all towers of this type<br>
                  DMG+50%, Range+20%<br>
                  Ability: ${t.ability}
                </div>
                <button onclick="game.upgradeTower(${t.id})" style="width: 100%; padding: 6px; font-size: 10px;">Upgrade - $${cost}</button>
              </div>
            `;
          });
          html += '</div>';
          content.innerHTML = html;
        } catch (e) {
          console.error('Upgrade menu error:', e);
        }
      },

      upgradeTower(type) {
        const cost = TOWER_TYPES[type].upgradeCost;
        if (this.state.money < cost) {
          this.showMessage('Not enough money for upgrade!', '#ef4444');
          return;
        }

        this.state.money -= cost;
        const towersUpgraded = this.state.towers.filter(t => t.type === type).length;

        this.state.towers.filter(t => t.type === type).forEach(t => {
          t.level++;
          t.upgraded = true;
        });

        this.showMessage(`‚úÖ Upgraded ${towersUpgraded} ${TOWER_TYPES[type].name} tower(s)!`, '#fbbf24');
        this.playSound(880, 0.1, 0.15);
        this.updateUI();
      },

      updateDailyModal() {
        try {
          const container = document.getElementById('dailyModifiers');
          if (!container) return;

          let html = '<div style="margin-bottom: 15px;">';
          this.state.dailyModifiers.forEach(mod => {
            let desc = '';
            if (mod.type === 'moneyMult') desc = `Money multiplied by ${mod.value.toFixed(2)}x`;
            if (mod.type === 'healthMult') desc = `Enemy health multiplied by ${mod.value.toFixed(2)}x`;
            if (mod.type === 'costMult') desc = `Tower costs multiplied by ${mod.value.toFixed(2)}x`;

            html += `<div class="daily-modifier">
              <div class="modifier-name">${mod.name}</div>
              <div class="modifier-effect">${desc}</div>
            </div>`;
          });
          html += '</div>';
          container.innerHTML = html;
        } catch (e) {
          console.error('Daily modal error:', e);
        }
      },

      showMessage(text, color = '#10b981') {
        const msg = document.createElement('div');
        msg.className = 'message';
        msg.textContent = text;
        msg.style.background = color;
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 2500);
      },

      showGameOver(won = false) {
        const screen = document.getElementById('gameOverScreen');
        const title = document.getElementById('gameOverTitle');
        const subtitle = document.getElementById('gameOverSubtitle');
        const stats = document.getElementById('gameOverStats');

        if (won) {
          title.textContent = 'üéâ VICTORY!';
          subtitle.textContent = 'You defeated the enemy!';
          this.playSound(1200, 0.3, 0.3);
        } else {
          title.textContent = '‚ò†Ô∏è GAME OVER';
          subtitle.textContent = 'You were defeated...';
          this.playSound(200, 0.3, 0.3);
        }

        stats.innerHTML = `
          <div class="stat-item"><div class="stat-item-label">Wave</div><div class="stat-item-value">${this.state.wave}</div></div>
          <div class="stat-item"><div class="stat-item-label">Kills</div><div class="stat-item-value">${this.state.kills}</div></div>
          <div class="stat-item"><div class="stat-item-label">Score</div><div class="stat-item-value">${this.state.score}</div></div>
        `;

        screen.classList.add('active');

        if (this.state.score > 0) {
          const scores = JSON.parse(localStorage.getItem('nexusScores') || '[]');
          const modeName = this.state.mode === 'campaign' ? `Campaign L${this.state.campaignLevel + 1}` : 'Endless';
          scores.push({
            name: modeName,
            score: this.state.score,
            mode: this.state.mode,
            wave: this.state.wave,
            date: new Date().toLocaleDateString()
          });
          localStorage.setItem('nexusScores', JSON.stringify(scores.slice(-50)));
        }

        if (this.state.kills >= 500) this.unlockAchievement('slayer');
        if (this.state.towersBuilt >= 20) this.unlockAchievement('builder');
        if (this.state.money >= 1000) this.unlockAchievement('wealthy');
      },

      retryLevel() {
        document.getElementById('gameOverScreen').classList.remove('active');
        if (this.state.mode === 'campaign') {
          this.loadCampaignLevel();
        } else if (this.state.mode === 'endless') {
          this.startEndless();
        } else {
          this.returnToMenu();
        }
      },

      returnToMenu() {
        document.getElementById('gameOverScreen').classList.remove('active');
        this.state.mode = null;
        this.state.towers = [];
        this.state.enemies = [];
        this.state.particles = [];
        this.showModal('menu');
      },

      changeDifficulty() {
        this.state.difficulty = document.getElementById('difficultySelect').value;
        this.showMessage(`Difficulty: ${this.state.difficulty.toUpperCase()}`, '#f59e0b');
      },

      updateVolume() {
        const vol = document.getElementById('volSlider').value;
        document.getElementById('volValue').textContent = vol;
      },

      updateSettings() {
        // Settings stored in checkboxes
      },

      unlockAchievement(id) {
        if (!this.state.achievements[id]) {
          this.state.achievements[id] = true;
          localStorage.setItem(`ach_${id}`, 'true');
          const ach = ACHIEVEMENTS.find(a => a.id === id);
          if (ach) {
            this.showMessage(`üèÜ Achievement Unlocked: ${ach.name}!`, '#fbbf24');
            this.playSound(1320, 0.2, 0.2);
          }
        }
      },

      loadCustomLevels() {
        const saved = localStorage.getItem('customLevels');
        if (saved) {
          this.state.customLevels = JSON.parse(saved);
        }
      },

      saveCustomLevel() {
        const name = document.getElementById('editorName').value || 'Custom Level';
        const money = parseInt(document.getElementById('editorMoney').value);
        const waves = parseInt(document.getElementById('editorWaves').value);
        const diff = parseFloat(document.getElementById('editorDiff').value);

        const level = { name, startMoney: money, waves, difficulty: diff };
        this.state.customLevels.push(level);
        localStorage.setItem('customLevels', JSON.stringify(this.state.customLevels));
        this.showMessage(`‚úÖ Level "${name}" saved!`, '#10b981');
        this.closeModal('editor');
      },

      testCustomLevel() {
        const name = document.getElementById('editorName').value || 'Custom Test';
        this.showMessage(`Testing "${name}"...`, '#3b82f6');
        this.closeModal('editor');
        this.startEndless();
      },

      generateDailyModifiers() {
        const modifiers = [
          { name: "Golden Day", type: "moneyMult", value: 1.5 },
          { name: "Hard Shell", type: "healthMult", value: 1.3 },
          { name: "Budget Cuts", type: "costMult", value: 0.7 },
          { name: "Economic Crisis", type: "moneyMult", value: 0.8 },
          { name: "Reinforced", type: "healthMult", value: 1.5 },
          { name: "Expensive", type: "costMult", value: 1.3 }
        ];

        this.state.dailyModifiers = [];
        for (let i = 0; i < 2; i++) {
          const idx = Math.floor(Math.random() * modifiers.length);
          this.state.dailyModifiers.push(modifiers[idx]);
        }
      },

      loadLeaderboard() {
        if (!localStorage.getItem('nexusScores')) {
          localStorage.setItem('nexusScores', '[]');
        }
      },

      showTutorial() {
        this.showModal('tutorial');
      },

      // ===== AUDIO =====
      playSound(freq, duration, volume) {
        try {
          if (!this.audioContext || !document.getElementById('soundCheck').checked) return;

          const oscillator = this.audioContext.createOscillator();
          const gain = this.audioContext.createGain();

          oscillator.connect(gain);
          gain.connect(this.audioContext.destination);

          oscillator.frequency.value = freq;
          gain.gain.setValueAtTime(volume * (parseFloat(document.getElementById('volSlider').value) / 100), this.audioContext.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);

          oscillator.start(this.audioContext.currentTime);
          oscillator.stop(this.audioContext.currentTime + duration);
        } catch (e) {
          // Audio error - ignore
        }
      },

      // ===== GAME LOOP =====
      renderLoop() {
        try {
          // Clear canvas
          this.ctx.fillStyle = '#0a0e27';
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

          // Draw grid
          this.ctx.strokeStyle = 'rgba(59, 130, 246, 0.05)';
          this.ctx.lineWidth = 1;
          for (let x = 0; x < this.canvas.width; x += 40) {
            this.ctx.beginPath();
            this.ctx.moveTo(x, 0);
            this.ctx.lineTo(x, this.canvas.height);
            this.ctx.stroke();
          }
          for (let y = 0; y < this.canvas.height; y += 40) {
            this.ctx.beginPath();
            this.ctx.moveTo(0, y);
            this.ctx.lineTo(this.canvas.width, y);
            this.ctx.stroke();
          }

          if (!this.state.isPaused && this.state.mode) {
            // Update enemies
            for (let i = this.state.enemies.length - 1; i >= 0; i--) {
              const e = this.state.enemies[i];
              e.y += e.vy * (this.state.speedX2 ? 2 : 1);
              e.x += e.vx * (this.state.speedX2 ? 2 : 1);

              if (e.y > this.canvas.height) {
                this.state.lives--;
                this.state.enemies.splice(i, 1);

                if (this.state.lives <= 0) {
                  this.state.waveActive = false;
                  this.showGameOver(false);
                }
                continue;
              }
            }

            // Tower shooting
            this.state.towers.forEach(t => {
              t.cooldown--;
              if (t.cooldown <= 0) {
                const tType = TOWER_TYPES[t.type];
                const target = this.state.enemies.find(e =>
                  Math.hypot(e.x - t.x, e.y - t.y) < tType.range
                );

                if (target) {
                  let damage = tType.damage * (1 + t.level * 0.5);
                  target.hp -= damage;
                  t.cooldown = tType.fireRate;

                  if (target.hp <= 0) {
                    this.state.enemies.splice(this.state.enemies.indexOf(target), 1);
                    this.state.kills++;
                    this.state.stats.totalKills++;
                    const reward = ENEMY_TYPES[target.type].reward;
                    this.state.money += reward;
                    this.state.score += reward;
                    t.kills++;

                    if (this.state.kills === 1) this.unlockAchievement('firstKill');
                  }

                  // Particles
                  for (let i = 0; i < 5; i++) {
                    this.state.particles.push({
                      x: target.x,
                      y: target.y,
                      vx: (Math.random() - 0.5) * 6,
                      vy: (Math.random() - 0.5) * 6,
                      life: 12,
                      color: tType.color
                    });
                  }

                  this.playSound(600 + Math.random() * 200, 0.05, 0.1);
                }
              }
            });

            // Update particles
            for (let i = this.state.particles.length - 1; i >= 0; i--) {
              const p = this.state.particles[i];
              p.x += p.vx;
              p.y += p.vy;
              p.vy += 0.3;
              p.life--;
              if (p.life <= 0) this.state.particles.splice(i, 1);
            }

            // Wave complete check
            if (this.state.waveActive && this.state.enemies.length === 0) {
              this.state.waveActive = false;
              this.showMessage(`‚ú® Wave ${this.state.wave} Complete!`, '#10b981');
              this.playSound(800, 0.2, 0.2);

              if (this.state.mode === 'campaign' && this.state.wave >= this.state.waveTarget) {
                this.levelComplete();
              }
            }
          }

          // Draw towers
          this.state.towers.forEach(t => {
            const tType = TOWER_TYPES[t.type];

            // Range indicator
            this.ctx.strokeStyle = `rgba(${parseInt(tType.color.slice(1, 3), 16)}, ${parseInt(tType.color.slice(3, 5), 16)}, ${parseInt(tType.color.slice(5, 7), 16)}, 0.08)`;
            this.ctx.lineWidth = 1;
            this.ctx.beginPath();
            this.ctx.arc(t.x, t.y, tType.range, 0, Math.PI * 2);
            this.ctx.stroke();

            // Tower body
            this.ctx.fillStyle = tType.color;
            this.ctx.beginPath();
            this.ctx.arc(t.x, t.y, 10, 0, Math.PI * 2);
            this.ctx.fill();

            // Tower emoji
            this.ctx.fillStyle = '#fff';
            this.ctx.font = 'bold 12px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.textBaseline = 'middle';
            this.ctx.fillText(tType.emoji, t.x, t.y);

            // Level indicator
            if (t.level > 0) {
              this.ctx.fillStyle = '#fbbf24';
              this.ctx.font = 'bold 9px Arial';
              this.ctx.fillText(`+${t.level}`, t.x + 9, t.y - 10);
            }
          });

          // Draw enemies
          this.state.enemies.forEach(e => {
            const eType = ENEMY_TYPES[e.type];

            // Enemy body
            this.ctx.fillStyle = eType.color;
            this.ctx.beginPath();
            this.ctx.arc(e.x, e.y, 8, 0, Math.PI * 2);
            this.ctx.fill();

            // Enemy emoji
            this.ctx.fillStyle = '#fff';
            this.ctx.font = 'bold 10px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.textBaseline = 'middle';
            this.ctx.fillText(eType.emoji, e.x, e.y);

            // HP bar
            const hpPercent = e.hp / e.maxHp;
            const hpColor = hpPercent > 0.5 ? '#22c55e' : hpPercent > 0.2 ? '#f59e0b' : '#ef4444';
            this.ctx.fillStyle = hpColor;
            this.ctx.fillRect(e.x - 12, e.y - 18, 24 * hpPercent, 2);
            this.ctx.strokeStyle = '#1f2937';
            this.ctx.lineWidth = 1;
            this.ctx.strokeRect(e.x - 12, e.y - 18, 24, 2);
          });

          // Draw particles
          this.state.particles.forEach(p => {
            this.ctx.fillStyle = p.color;
            this.ctx.globalAlpha = p.life / 12;
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
            this.ctx.fill();
          });
          this.ctx.globalAlpha = 1;

          // Pause overlay
          if (this.state.isPaused) {
            this.ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            this.ctx.fillStyle = '#fff';
            this.ctx.font = 'bold 48px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.fillText('PAUSED', this.canvas.width / 2, this.canvas.height / 2);
          }

          this.updateUI();
        } catch (e) {
          console.error('Render loop error:', e);
        }

        requestAnimationFrame(() => this.renderLoop());
      }
    };

    // Initialize game
    game.init();
  </script>

</body>
</html>
