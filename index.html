<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nexus Defense â€“ Improved</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: linear-gradient(135deg, #0b132b 0%, #1c2a5a 100%);
      color: #d0e0ff;
      font-family: 'Courier New', monospace;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      overflow-x: hidden;
    }
    h1 {
      font-size: clamp(1.6rem, 5vw, 2.2rem);
      margin: 8px 0 4px;
      text-shadow: 0 0 24px #3b82f6cc;
      color: #93c5fd;
      letter-spacing: 3px;
    }
    .subtitle { color:#60a5fa; font-size:0.8rem; opacity:0.8; margin-bottom:12px; }

    .container {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      justify-content: center;
      flex-wrap: wrap;
      width: 100%;
      max-width: 1400px;
    }

    .game-area { display: flex; flex-direction: column; gap: 12px; flex: 1; min-width: 320px; }

    canvas {
      background: linear-gradient(45deg, #132043, #1e3a6b);
      border: 2px solid #3b82f6;
      border-radius: 10px;
      box-shadow: 0 0 40px #3b82f680, inset 0 0 30px #3b82f640;
      image-rendering: crisp-edges;
      touch-action: none;
      width: 100%;
      height: auto;
      aspect-ratio: 3 / 2;
      max-width: 960px;
    }

    .canvas-overlay { position: relative; }

    .pause-overlay {
      position: absolute; inset: 0;
      background: rgba(0,0,0,0.75);
      border-radius: 10px;
      display: none;
      place-items: center;
      font-size: 3rem;
      font-weight: bold;
      color: #93c5fd;
      text-shadow: 0 0 25px #3b82f6;
      z-index: 20;
    }
    .pause-overlay.active { display: grid; }

    .boss-warning {
      position: absolute; inset: 0;
      background: rgba(220,38,38,0.92);
      color: white;
      place-content: center;
      font-size: 3rem;
      font-weight: bold;
      text-shadow: 0 0 25px black;
      z-index: 15;
      pointer-events: none;
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse { 0%,100% { transform:scale(1); } 50% { transform:scale(1.04); } }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 8px;
      width: 100%;
      max-width: 960px;
    }

    button {
      padding: 10px;
      font-size: 0.9rem;
      background: linear-gradient(145deg, #3b82f6, #1e40af);
      border: 2px solid #60a5fa;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.18s ease;
    }
    button:hover { background: linear-gradient(145deg, #60a5fa, #3b82f6); transform: translateY(-1px); box-shadow: 0 6px 20px #3b82f680; }
    button:active { transform: translateY(0); }
    button.active { background: linear-gradient(145deg, #10b981, #047857); border-color: #34d399; }

    .sidebar {
      background: rgba(15,23,42,0.85);
      border: 2px solid #3b82f6;
      border-radius: 10px;
      width: 100%;
      max-width: 340px;
      box-shadow: 0 0 30px #3b82f650;
      display: flex;
      flex-direction: column;
      min-height: 400px;
    }

    .sidebar-tabs { display: flex; border-bottom: 2px solid #3b82f640; }
    .tab-btn {
      flex:1; padding:12px; text-align:center; background:#3b82f620; border:none;
      color:#60a5fa; font-weight:bold; cursor:pointer; transition:all 0.2s;
    }
    .tab-btn:hover { background:#3b82f640; }
    .tab-btn.active { background:#3b82f660; color:#93c5fd; }

    .tab-content { display:none; padding:16px; flex:1; overflow-y:auto; }
    .tab-content.active { display:block; }

    .stat-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 16px;
    }
    .stat-card {
      background: #3b82f620;
      border: 1px solid #3b82f650;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
    }
    .stat-label { color:#60a5fa; font-size:0.75rem; text-transform:uppercase; }
    .stat-value { color:#93c5fd; font-size:1.4rem; font-weight:bold; }

    .tower-card {
      background: #3b82f615;
      border: 1px solid #3b82f650;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tower-card:hover { background: #3b82f630; }

    .selected-tower-panel {
      background: #3b82f630;
      border: 1px solid #60a5fa;
      border-radius: 8px;
      padding: 12px;
    }

    .upgrade-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 12px;
    }
    .upgrade-btn {
      padding: 8px; font-size: 0.85rem;
      background: linear-gradient(145deg, #3b82f6, #1e40af);
      border: 1px solid #60a5fa;
    }
    .upgrade-btn.sell { background: linear-gradient(145deg, #ef4444, #b91c1c); border-color: #fca5a5; }
    .upgrade-btn.repair { background: linear-gradient(145deg, #f59e0b, #b45309); border-color: #fbbf24; }

    .message {
      position: fixed; top: 16px; left: 50%;
      transform: translateX(-50%);
      background: rgba(16,185,129,0.95);
      color: white;
      padding: 10px 24px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 999;
      opacity: 0;
      animation: msg 3s forwards;
    }
    @keyframes msg { 0%,100% {opacity:0; transform:translate(-50%,-20px);} 10%,80% {opacity:1; transform:translate(-50%,0);} }

    .game-info {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    .badge {
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: bold;
    }
    .wave-badge     { background:#3b82f6cc; }
    .boss-badge     { background:#ef4444cc; animation: pulseBadge 1.4s infinite; }
    .failure-badge  { background:#ef4444ee; }

    @keyframes pulseBadge { 0%,100% {transform:scale(1);} 50% {transform:scale(1.08);} }

    @media (max-width: 900px) {
      .container { flex-direction: column; }
      .sidebar { max-width: 100%; }
    }
  </style>
</head>
<body>

<h1>âš¡ NEXUS DEFENSE âš¡</h1>
<p class="subtitle">Place towers â€¢ Survive waves â€¢ Defeat bosses every 5 waves</p>

<div class="container">
  <div class="game-area">
    <div class="canvas-overlay">
      <canvas id="c" width="960" height="640"></canvas>
      <div class="pause-overlay" id="pause">PAUSED</div>
      <div class="boss-warning" id="bossWarn" style="display:none">âš  BOSS INCOMING âš </div>
    </div>

    <div class="controls">
      <button id="btn0">ğŸ”µ Laser ($180)</button>
      <button id="btn1">ğŸ’£ Cannon ($260)</button>
      <button id="btn2">ğŸŸ¢ Pulse ($220)</button>
      <button id="pauseBtn">â¸ Pause</button>
      <button id="waveBtn">â–¶ Next Wave</button>
      <button onclick="resetGame()" style="background:linear-gradient(145deg,#dc2626,#991b1b)">Reset</button>
    </div>

    <div class="game-info">
      <div class="badge wave-badge" id="waveInfo">Wave 1</div>
      <div class="badge" id="diff">Normal</div>
      <div class="badge boss-badge" id="bossActive" style="display:none">BOSS WAVE</div>
      <div class="badge failure-badge" id="bossFails" style="display:none">Boss fails: 0/3</div>
    </div>
  </div>

  <div class="sidebar">
    <div class="sidebar-tabs">
      <button class="tab-btn active" data-tab="stats">Stats</button>
      <button class="tab-btn" data-tab="towers">Towers</button>
      <button class="tab-btn" data-tab="selected">Selected</button>
    </div>

    <div class="tab-content active" id="stats">
      <div class="stat-grid">
        <div class="stat-card"><div class="stat-label">Balance</div><div class="stat-value" id="money">$800</div></div>
        <div class="stat-card"><div class="stat-label">Wave</div><div class="stat-value" id="lvl">1</div></div>
        <div class="stat-card"><div class="stat-label">Towers</div><div class="stat-value" id="towerCount">0</div></div>
        <div class="stat-card"><div class="stat-label">Kills</div><div class="stat-value" id="kills">0</div></div>
      </div>
      <div style="font-size:0.8rem; color:#60a5fa; background:#3b82f620; padding:10px; border-radius:6px;">
        Boss every 5 waves â€¢ 3 boss escapes = reset â€¢ Towers damaged by enemies
      </div>
    </div>

    <div class="tab-content" id="towers">
      <div class="tower-card" data-type="0">
        <strong>Laser</strong><br>DMG 12 | Fast | Range 130<br>Cost $180
      </div>
      <div class="tower-card" data-type="1">
        <strong>Cannon</strong><br>DMG 22 | Slow | Range 160<br>Cost $260
      </div>
      <div class="tower-card" data-type="2">
        <strong>Pulse</strong><br>DMG 9 | Medium | Range 170<br>Cost $220
      </div>
    </div>

    <div class="tab-content" id="selected">
      <div id="noSelect" style="text-align:center; padding:40px 0; color:#60a5fa;">Click a tower on map</div>
      <div id="selPanel" class="selected-tower-panel" style="display:none">
        <strong id="selName"></strong><br>
        <div id="selStats"></div>
        <div style="margin:10px 0;">
          Health: <span id="selHp">100/100</span>
          <div style="height:8px;background:#333;border-radius:4px;overflow:hidden;">
            <div id="hpBar" style="height:100%;width:100%;background:#22c55e;transition:width 0.3s;"></div>
          </div>
        </div>
        <div class="upgrade-grid">
          <button class="upgrade-btn repair" onclick="repair()">Repair ($35)</button>
          <button class="upgrade-btn" onclick="up('dmg')">DMG +4 ($55)</button>
          <button class="upgrade-btn" onclick="up('rng')">Range +25 ($65)</button>
          <button class="upgrade-btn" onclick="up('spd')">Speed ($75)</button>
          <button class="upgrade-btn sell" onclick="sell()">Sell (~60%)</button>
          <button class="upgrade-btn" onclick="deselect()">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Game Core
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const c = document.getElementById('c');
const ctx = c.getContext('2d');
let cw = c.width, ch = c.height;

let money = 800;
let wave = 1;
let kills = 0;
let placing = -1;
let selected = null;
let paused = false;
let waveRunning = false;
let bossWave = false;
let bossFails = 0;
let bossDefeated = false;
let escaped = 0;

const towers   = [];
const enemies  = [];
const particles = [];

// Tower types
const TOWER_DEFS = [
  {name:"Laser",  cost:180, color:"#00d4ff", dmg:12, range:130, rate:36, size:15},
  {name:"Cannon", cost:260, color:"#ff8c00", dmg:22, range:160, rate:64, size:17},
  {name:"Pulse",  cost:220, color:"#22ffaa", dmg:9,  range:170, rate:28, size:16}
];

// Simple path (you can expand later)
const PATH = [
  {x:480, y:-30}, {x:480, y:140}, {x:220, y:140}, {x:220, y:300},
  {x:740, y:300}, {x:740, y:460}, {x:120, y:460}, {x:120, y:ch+30}
];

function dist(x1,y1,x2,y2){ return Math.hypot(x2-x1,y2-y1); }

function msg(txt, col="#10b981"){
  const el = document.createElement("div");
  el.className="message";
  el.textContent = txt;
  el.style.background = col;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 3200);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Tower & Upgrade logic
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addTower(x,y,type){
  const t = TOWER_DEFS[type];
  towers.push({
    x,y,type,
    color: t.color,
    dmg: t.dmg,
    range: t.range,
    rate: t.rate,
    size: t.size,
    cd: 0,
    upgrades: {dmg:0, rng:0, spd:0},
    hp: 100, maxHp:100
  });
}

function selectType(idx){
  if(money < TOWER_DEFS[idx].cost) return msg("Not enough money!", "#ef4444");
  placing = idx;
  selected = null;
  document.getElementById("selPanel").style.display="none";
  document.getElementById("noSelect").style.display="block";
  document.querySelectorAll(".controls button").forEach(b=>b.classList.remove("active"));
  document.getElementById(`btn${idx}`).classList.add("active");
}

function selectTower(t){
  selected = t;
  document.getElementById("noSelect").style.display="none";
  document.getElementById("selPanel").style.display="block";

  document.getElementById("selName").textContent = TOWER_DEFS[t.type].name;
  document.getElementById("selStats").innerHTML = `DMG ${t.dmg} | Range ${t.range} | Speed ${t.rate}`;
  document.getElementById("selHp").textContent = `${Math.round(t.hp)}/${t.maxHp}`;
  document.getElementById("hpBar").style.width = (t.hp/t.maxHp*100)+"%";
  document.getElementById("hpBar").style.background = t.hp > 60 ? "#22c55e" : t.hp > 25 ? "#f59e0b" : "#ef4444";
}

function deselect(){
  selected = null;
  document.getElementById("selPanel").style.display="none";
  document.getElementById("noSelect").style.display="block";
}

function repair(){
  if(!selected || money < 35) return msg("Need $35!", "#ef4444");
  selected.hp = Math.min(selected.maxHp, selected.hp + 60);
  money -= 35;
  selectTower(selected);
  msg("Tower repaired", "#10b981");
}

function up(stat){
  if(!selected) return;
  const costs = {dmg:55, rng:65, spd:75};
  if(money < costs[stat]) return msg(`Need $${costs[stat]}!`, "#ef4444");

  if(stat==="dmg") selected.dmg += 4;
  else if(stat==="rng") selected.range += 25;
  else if(stat==="spd") selected.rate = Math.max(12, selected.rate - 6);

  selected.upgrades[stat]++;
  money -= costs[stat];
  selectTower(selected);
  msg(`${stat.toUpperCase()} upgraded!`, "#10b981");
}

function sell(){
  if(!selected) return;
  const refund = Math.round(TOWER_DEFS[selected.type].cost * 0.62);
  money += refund;
  towers.splice(towers.indexOf(selected),1);
  deselect();
  msg(`Sold for $${refund}`, "#fbbf24");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Enemy spawn & movement
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function spawnEnemy(isBoss = false){
  const baseHp = isBoss ? 180 + wave*45 : 45 + wave*18;
  const hp = isBoss ? baseHp * 2.8 : baseHp * (1 + Math.random()*0.3);
  enemies.push({
    x: PATH[0].x,
    y: PATH[0].y,
    hp, maxHp:hp,
    speed: isBoss ? 0.9 : 1.4 + wave*0.08,
    r: isBoss ? 22 : 11,
    idx: 0,
    prog: 0,
    isBoss,
    reward: isBoss ? 120 : 22
  });
}

function startWave(){
  if(waveRunning) return;
  waveRunning = true;
  bossWave = wave % 5 === 0;
  bossDefeated = false;
  escaped = 0;
  document.getElementById("waveBtn").disabled = true;

  if(bossWave){
    document.getElementById("bossWarn").style.display = "grid";
    setTimeout(()=>{
      document.getElementById("bossWarn").style.display = "none";
      spawnLoop(true);
    }, 2800);
  } else {
    spawnLoop(false);
  }
}

function spawnLoop(isBossWave){
  let spawned = 0;
  const total = isBossWave ? 1 : 8 + Math.floor(wave * 1.8);
  const interval = isBossWave ? 0 : 550;

  const spawner = setInterval(()=>{
    if(paused) return;
    if(spawned < total){
      spawnEnemy(isBossWave && spawned === 0);
      spawned++;
    }
    if(spawned >= total) clearInterval(spawner);
  }, interval);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Particles
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function burst(x,y,col,count=12,life=24){
  for(let i=0;i<count;i++){
    const a = Math.random()*Math.PI*2;
    const v = 1.5 + Math.random()*2.5;
    particles.push({
      x,y,
      vx: Math.cos(a)*v,
      vy: Math.sin(a)*v,
      life, maxLife:life,
      col, size: 2.5 + Math.random()*2
    });
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Input
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

c.addEventListener("pointerdown", e=>{
  if(paused) return;
  const r = c.getBoundingClientRect();
  const x = (e.clientX - r.left) * (cw / r.width);
  const y = (e.clientY - r.top)  * (ch / r.height);

  if(placing >= 0){
    if(money >= TOWER_DEFS[placing].cost){
      addTower(x,y,placing);
      money -= TOWER_DEFS[placing].cost;
      burst(x,y,TOWER_DEFS[placing].color,16,30);
      placing = -1;
      document.querySelectorAll(".controls button").forEach(b=>b.classList.remove("active"));
    }
    return;
  }

  // select existing tower
  for(const t of towers){
    if(dist(x,y,t.x,t.y) < 28){
      selectTower(t);
      return;
    }
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Pause / Reset
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById("pauseBtn").onclick = ()=>{
  if(!waveRunning) return msg("Wave not started", "#ef4444");
  paused = !paused;
  document.getElementById("pause").classList.toggle("active", paused);
  document.getElementById("pauseBtn").textContent = paused ? "â–¶ Resume" : "â¸ Pause";
};

function resetGame(){
  if(!confirm("Reset everything?")) return;
  Object.assign(window, {
    money:800, wave:1, kills:0, placing:-1, selected:null, paused:false,
    waveRunning:false, bossWave:false, bossFails:0, bossDefeated:false, escaped:0
  });
  towers.length = enemies.length = particles.length = 0;
  document.getElementById("waveBtn").disabled = false;
  document.getElementById("pauseBtn").textContent = "â¸ Pause";
  document.getElementById("pause").classList.remove("active");
  document.getElementById("bossActive").style.display="none";
  document.getElementById("bossFails").style.display="none";
  msg("Game reset", "#3b82f6");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Main loop
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function loop(){
  ctx.clearRect(0,0,cw,ch);

  // faint grid
  ctx.strokeStyle = "#3b82f622";
  ctx.lineWidth = 1;
  for(let x=0;x<cw;x+=40) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,ch); ctx.stroke(); }
  for(let y=0;y<ch;y+=40) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(cw,y); ctx.stroke(); }

  // path
  ctx.strokeStyle = "#60a5fa80";
  ctx.lineWidth = 5;
  ctx.lineCap = "round";
  ctx.beginPath();
  ctx.moveTo(PATH[0].x, PATH[0].y);
  for(const p of PATH) ctx.lineTo(p.x, p.y);
  ctx.stroke();

  if(!paused){
    // towers update
    for(const t of towers){
      // damage from nearby enemies
      for(const e of enemies){
        if(dist(t.x,t.y,e.x,e.y) < e.r + 20){
          t.hp -= e.isBoss ? 0.6 : 0.25;
          if(t.hp <= 0){
            burst(t.x,t.y,t.color,24,40);
            towers.splice(towers.indexOf(t),1);
            if(selected === t) deselect();
            msg("Tower destroyed!", "#ef4444");
            continue;
          }
        }
      }

      // draw tower
      ctx.fillStyle = t.color;
      ctx.beginPath();
      ctx.arc(t.x,t.y,t.size,0,Math.PI*2);
      ctx.fill();
      // range
      if(selected === t){
        ctx.strokeStyle = "#60a5faaa";
        ctx.lineWidth = 3;
        ctx.setLineDash([6,8]);
        ctx.beginPath();
        ctx.arc(t.x,t.y,t.range,0,Math.PI*2);
        ctx.stroke();
        ctx.setLineDash([]);
      }

      // health bar
      if(t.hp < t.maxHp){
        const pct = t.hp / t.maxHp;
        ctx.fillStyle = "#111";
        ctx.fillRect(t.x-20, t.y-28, 40, 6);
        ctx.fillStyle = pct>0.6?"#22c55e":pct>0.3?"#f59e0b":"#ef4444";
        ctx.fillRect(t.x-20, t.y-28, 40*pct, 6);
      }

      if(t.cd > 0){ t.cd--; continue; }

      let best = null, bestD = t.range+1;
      for(const e of enemies){
        const d = dist(t.x,t.y,e.x,e.y);
        if(d < bestD){
          best = e;
          bestD = d;
        }
      }

      if(best){
        best.hp -= t.dmg;
        t.cd = t.rate;
        burst(best.x, best.y, t.color, 6, 18);

        // laser line
        ctx.strokeStyle = t.color + "cc";
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(t.x, t.y);
        ctx.lineTo(best.x, best.y);
        ctx.stroke();
      }
    }

    // enemies
    for(let i=enemies.length-1; i>=0; i--){
      const e = enemies[i];

      if(e.idx < PATH.length-1){
        const a = PATH[e.idx], b = PATH[e.idx+1];
        const d = dist(a.x,a.y,b.x,b.y);
        e.prog += e.speed / d;
        if(e.prog >= 1){
          e.idx++;
          e.prog = 0;
        }
        e.x = a.x + (b.x - a.x) * e.prog;
        e.y = a.y + (b.y - a.y) * e.prog;
      }

      // draw
      ctx.fillStyle = e.isBoss ? "#dc2626" : ["#fbbf24","#ef4444","#a855f7"][Math.min(2,e.idx%3)];
      ctx.beginPath();
      ctx.arc(e.x,e.y,e.r,0,Math.PI*2);
      ctx.fill();

      // hp bar
      const hpPct = e.hp / e.maxHp;
      ctx.fillStyle = "#111";
      ctx.fillRect(e.x-22, e.y-30, 44, 6);
      ctx.fillStyle = hpPct>0.5?"#22c55e":hpPct>0.25?"#f59e0b":"#ef4444";
      ctx.fillRect(e.x-22, e.y-30, 44*hpPct, 6);

      if(e.hp <= 0){
        burst(e.x,e.y,"#fbbf24",18,35);
        money += e.reward;
        kills++;
        enemies.splice(i,1);
        if(e.isBoss){
          bossDefeated = true;
          msg("BOSS DEFEATED! +$"+e.reward, "#fbbf24");
        }
        continue;
      }

      if(e.y > ch + 40){
        enemies.splice(i,1);
        if(e.isBoss){
          bossFails++;
          waveRunning = false;
          document.getElementById("waveBtn").disabled = false;
          document.getElementById("bossFails").textContent = `Boss fails: ${bossFails}/3`;
          document.getElementById("bossFails").style.display = "inline-block";
          msg(`Boss escaped! (${bossFails}/3)`, "#ef4444");
          if(bossFails >= 3){
            msg("3 BOSS ESCAPES â†’ GAME RESET", "#ff1744");
            resetGame();
          }
        } else {
          escaped++;
          money = Math.max(0, money - 45);
          burst(e.x,e.y,"#ef4444",10,25);
        }
      }
    }
  }

  // particles
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.18;
    p.life--;
    ctx.globalAlpha = p.life / p.maxLife;
    ctx.fillStyle = p.col;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
    ctx.fill();
    if(p.life <= 0) particles.splice(i,1);
  }
  ctx.globalAlpha = 1;

  // wave end check
  if(waveRunning && enemies.length === 0){
    waveRunning = false;
    document.getElementById("waveBtn").disabled = false;

    if(bossWave){
      if(bossDefeated){
        bossFails = 0;
        document.getElementById("bossFails").style.display="none";
        money += Math.round(money * 0.12);
        msg(`BOSS CLEARED! +${Math.round(money*0.12)} bonus`, "#fbbf24");
      }
    } else if(escaped <= 3){
      msg(`Wave ${wave} complete`, "#10b981");
    } else {
      msg(`Too many escaped (${escaped}) â†’ retry`, "#ef4444");
      return; // retry same wave
    }

    wave++;
    if(wave % 5 === 0) document.getElementById("bossActive").style.display="inline-block";
    else document.getElementById("bossActive").style.display="none";
  }

  // UI
  document.getElementById("money").textContent = "$"+money;
  document.getElementById("lvl").textContent = wave;
  document.getElementById("towerCount").textContent = towers.length;
  document.getElementById("kills").textContent = kills;
  document.getElementById("waveInfo").textContent = `Wave ${wave}  |  Enemies: ${enemies.length}`;

  let diff = wave <= 4 ? "Easy" : wave <= 9 ? "Normal" : wave <= 15 ? "Hard" : "Insane";
  document.getElementById("diff").textContent = diff;

  requestAnimationFrame(loop);
}

loop();

// tower button listeners
TOWER_DEFS.forEach((_,i)=>{
  document.getElementById(`btn${i}`).onclick = ()=>selectType(i);
});

// tab switching
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".tab-btn, .tab-content").forEach(el=>el.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  };
});

// tower card quick select
document.querySelectorAll("#towers .tower-card").forEach(card=>{
  card.onclick = ()=>selectType(+card.dataset.type);
});

// start wave button
document.getElementById("waveBtn").onclick = startWave;
</script>
</body>
</html>
