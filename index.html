<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Strategy Defense</title>
<style>
  body {
    background:#0f172a;
    color:#e5e7eb;
    font-family: system-ui, sans-serif;
    text-align:center;
  }
  canvas {
    background: linear-gradient(#1e293b, #020617);
    border:2px solid #334155;
    display:block;
    margin:10px auto;
  }
  button {
    padding:10px 14px;
    margin:5px;
    font-size:16px;
    background:#2563eb;
    border:none;
    color:white;
    border-radius:6px;
    cursor:pointer;
  }
  button:hover { background:#1d4ed8; }
</style>
</head>

<body>
<h1>Strategy Defense</h1>

<canvas id="game" width="900" height="500"></canvas>

<div>
  <button onclick="selectTower()">Build Tower ($150)</button>
  <button onclick="startWave()">Start Wave</button>
</div>

<p id="info"></p>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let money = 500;
let level = 1;
let waveActive = false;
let placingTower = false;

const towers = [];
const enemies = [];

// ======================
// TOWER
// ======================
function createTower(x,y){
  towers.push({
    x, y,
    range:120,
    damage:12,
    fireRate:40,
    cooldown:0
  });
}

// ======================
// ENEMY
// ======================
function spawnEnemy(){
  enemies.push({
    x: Math.random() * (canvas.width-40) + 20,
    y: -20,
    hp: 30 + level*10,
    speed: 0.6 + level*0.05
  });
}

// ======================
// INPUT
// ======================
canvas.addEventListener("click", e=>{
  if(!placingTower) return;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  if(money >= 150){
    createTower(x,y);
    money -= 150;
  }
  placingTower = false;
});

// ======================
// BUTTONS
// ======================
function selectTower(){
  placingTower = true;
}

function startWave(){
  if(waveActive) return;
  waveActive = true;
  let count = 0;
  const interval = setInterval(()=>{
    spawnEnemy();
    count++;
    if(count >= 5 + level*2){
      clearInterval(interval);
    }
  }, 600);
}

// ======================
// GAME LOOP
// ======================
function update(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Draw towers
  towers.forEach(t=>{
    ctx.fillStyle="#38bdf8";
    ctx.beginPath();
    ctx.arc(t.x,t.y,14,0,Math.PI*2);
    ctx.fill();

    ctx.strokeStyle="rgba(56,189,248,0.2)";
    ctx.beginPath();
    ctx.arc(t.x,t.y,t.range,0,Math.PI*2);
    ctx.stroke();
  });

  // Draw enemies
  enemies.forEach((e,i)=>{
    e.y += e.speed;

    ctx.fillStyle="#ef4444";
    ctx.fillRect(e.x-10,e.y-10,20,20);

    // HP bar
    ctx.fillStyle="#22c55e";
    ctx.fillRect(e.x-10,e.y-16,(e.hp/(30+level*10))*20,4);

    // Remove if dead
    if(e.hp <= 0){
      enemies.splice(i,1);
      money += 25;
    }

    // Remove if escaped
    if(e.y > canvas.height){
      enemies.splice(i,1);
      money -= 50;
    }
  });

  // Shooting logic (FIXED)
  towers.forEach(t=>{
    if(t.cooldown > 0){
      t.cooldown--;
      return;
    }

    for(const e of enemies){
      const dx = e.x - t.x;
      const dy = e.y - t.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if(dist < t.range){
        e.hp -= t.damage;
        t.cooldown = t.fireRate;
        break;
      }
    }
  });

  // Wave complete
  if(waveActive && enemies.length === 0){
    waveActive = false;
    level++;
  }

  document.getElementById("info").innerText =
    `Money: $${money} | Level: ${level} | Towers: ${towers.length}`;

  requestAnimationFrame(update);
}

update();
</script>
</body>
</html>
